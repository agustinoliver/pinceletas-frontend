<div class="dashboard-container">
  <!-- Header del Dashboard -->
  <div class="dashboard-header">
    <div class="row align-items-center">
      <div class="col">
        <h1 class="dashboard-title">
          <i class="fas fa-chart-line me-3 text-primary"></i>
          Sistema de Reportes
        </h1>
        <p class="dashboard-subtitle">Genera y descarga reportes detallados del sistema</p>
      </div>
      <div class="col-auto">
        <button class="btn btn-primary" (click)="refreshDashboard()" [disabled]="loading">
          <i class="fas fa-sync-alt me-2" [class.fa-spin]="loading"></i>
          {{ loading ? 'Actualizando...' : 'Actualizar' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="loading-container">
    <div class="loading-spinner"></div>
    <p class="loading-text">Cargando reportes...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error && !loading" class="error-container">
    <div class="alert alert-danger" role="alert">
      <i class="fas fa-exclamation-triangle me-2"></i>
      {{ error }}
      <button class="btn btn-sm btn-outline-danger ms-3" (click)="refreshDashboard()">
        Reintentar
      </button>
    </div>
  </div>

  <!-- Dashboard Content -->
  <div *ngIf="dashboardData && !loading" class="dashboard-content fade-in">
    
    <!-- Navegación por Tabs de Reportes -->
    <div class="row mb-4">
      <div class="col-12">
        <ul class="nav nav-tabs dashboard-tabs">
          <li class="nav-item">
            <a class="nav-link" [class.active]="activeTab === 'usuarios'" 
               (click)="setActiveTab('usuarios')">
              <i class="fas fa-users me-2"></i>
              Reporte de Usuarios
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" [class.active]="activeTab === 'productos'" 
               (click)="setActiveTab('productos')">
              <i class="fas fa-boxes me-2"></i>
              Reporte de Productos
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" [class.active]="activeTab === 'pedidos'" 
               (click)="setActiveTab('pedidos')">
              <i class="fas fa-shopping-cart me-2"></i>
              Reporte de Pedidos
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" [class.active]="activeTab === 'compras-usuarios'" 
               (click)="setActiveTab('compras-usuarios')">
              <i class="fas fa-user-tag me-2"></i>
              Compras por Usuario
            </a>
          </li>
        </ul>
      </div>
    </div>

    <!-- TARJETAS DE RESUMEN GENERAL -->
    <div class="row mb-4">
      <div class="col-md-3">
        <div class="card summary-card">
          <div class="card-body">
            <div class="d-flex align-items-center">
              <div class="summary-icon bg-primary">
                <i class="fas fa-users"></i>
              </div>
              <div class="ms-3">
                <h3 class="summary-value">{{ dashboardData.userStats.totalUsers }}</h3>
                <p class="summary-label">Total Usuarios</p>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-md-3">
        <div class="card summary-card">
          <div class="card-body">
            <div class="d-flex align-items-center">
              <div class="summary-icon bg-success">
                <i class="fas fa-cubes"></i>
              </div>
              <div class="ms-3">
                <h3 class="summary-value">{{ dashboardData.productStats.totalProducts }}</h3>
                <p class="summary-label">Total Productos</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-md-3">
        <div class="card summary-card">
          <div class="card-body">
            <div class="d-flex align-items-center">
              <div class="summary-icon bg-warning">
                <i class="fas fa-shopping-cart"></i>
              </div>
              <div class="ms-3">
                <h3 class="summary-value">{{ getOrdersStats()?.totalOrders || 0 }}</h3>
                <p class="summary-label">Total Pedidos</p>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-md-3">
        <div class="card summary-card">
          <div class="card-body">
            <div class="d-flex align-items-center">
              <div class="summary-icon bg-info">
                <i class="fas fa-chart-line"></i>
              </div>
              <div class="ms-3">
                <h3 class="summary-value">{{ formatCurrency(getOrdersStats()?.totalRevenue || 0) }}</h3>
                <p class="summary-label">Ingresos Totales</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- REPORTE DE USUARIOS ACTIVOS/INACTIVOS -->
    <div *ngIf="activeTab === 'usuarios'" class="tab-content fade-in">
      <div class="card report-card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="card-title mb-0">
            <i class="fas fa-users me-2 text-primary"></i>
            Reporte de Usuarios Activos/Inactivos
          </h5>
          <div class="report-actions">
            <button class="btn btn-success btn-sm me-2" (click)="downloadReport('usuarios', 'excel')">
              <i class="fas fa-file-excel me-1"></i> Excel
            </button>
            <button class="btn btn-danger btn-sm" (click)="downloadReport('usuarios', 'pdf')">
              <i class="fas fa-file-pdf me-1"></i> PDF
            </button>
          </div>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <div class="card chart-card">
                <div class="card-body">
                  <google-chart 
                    *ngIf="pieChartData.length > 0"
                    [type]="pieChartType"
                    [data]="pieChartData"
                    [columns]="pieChartColumns"
                    [options]="pieChartOptions">
                  </google-chart>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="table-responsive">
                <table class="table table-striped">
                  <thead>
                    <tr>
                      <th>Estado</th>
                      <th>Cantidad</th>
                      <th>Porcentaje</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td><span class="badge bg-success">Activos</span></td>
                      <td><strong>{{ dashboardData.userStats.activeUsers }}</strong></td>
                      <td>{{ dashboardData.userStats.activePercentage | number:'1.1-1' }}%</td>
                    </tr>
                    <tr>
                      <td><span class="badge bg-warning">Inactivos</span></td>
                      <td><strong>{{ dashboardData.userStats.inactiveUsers }}</strong></td>
                      <td>{{ (dashboardData.userStats.inactiveUsers / dashboardData.userStats.totalUsers * 100) | number:'1.1-1' }}%</td>
                    </tr>
                    <tr class="table-primary">
                      <td><strong>Total</strong></td>
                      <td><strong>{{ dashboardData.userStats.totalUsers }}</strong></td>
                      <td><strong>100%</strong></td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- REPORTE DE PRODUCTOS -->
    <div *ngIf="activeTab === 'productos'" class="tab-content fade-in">
      
      <!-- Productos Más Vendidos -->
      <div class="card report-card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="card-title mb-0">
            <i class="fas fa-trophy me-2 text-warning"></i>
            Reporte de Productos Más Vendidos
          </h5>
          <div class="report-actions">
            <button class="btn btn-success btn-sm me-2" (click)="downloadReport('productos-vendidos', 'excel')">
              <i class="fas fa-file-excel me-1"></i> Excel
            </button>
            <button class="btn btn-danger btn-sm" (click)="downloadReport('productos-vendidos', 'pdf')">
              <i class="fas fa-file-pdf me-1"></i> PDF
            </button>
          </div>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <div class="card chart-card">
                <div class="card-body">
                  <google-chart 
                    *ngIf="topProductsChartData.length > 0"
                    [type]="topProductsChartType"
                    [data]="topProductsChartData"
                    [columns]="topProductsChartColumns"
                    [options]="topProductsChartOptions">
                  </google-chart>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="table-responsive">
                <table class="table table-striped">
                  <thead>
                    <tr>
                      <th>Producto</th>
                      <th>Categoría</th>
                      <th>Unidades Vendidas</th>
                      <th>Ingresos</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let product of dashboardData.topSellingProducts.slice(0, 10)">
                      <td><strong>{{ product.productName }}</strong></td>
                      <td><span class="badge bg-secondary">{{ product.categoryName }}</span></td>
                      <td><span class="badge bg-primary">{{ product.unitsSold }}</span></td>
                      <td class="fw-bold text-success">{{ formatCurrency(product.totalRevenue) }}</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Productos por Categoría -->
      <div class="card report-card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="card-title mb-0">
            <i class="fas fa-layer-group me-2 text-primary"></i>
            Reporte de Productos por Categoría
          </h5>
          <div class="report-actions">
            <button class="btn btn-success btn-sm me-2" (click)="downloadReport('productos-categoria', 'excel')">
              <i class="fas fa-file-excel me-1"></i> Excel
            </button>
            <button class="btn btn-danger btn-sm" (click)="downloadReport('productos-categoria', 'pdf')">
              <i class="fas fa-file-pdf me-1"></i> PDF
            </button>
          </div>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <div class="card chart-card">
                <div class="card-body">
                  <google-chart 
                    *ngIf="categoryChartData.length > 0"
                    [type]="categoryChartType"
                    [data]="categoryChartData"
                    [columns]="categoryChartColumns"
                    [options]="categoryChartOptions">
                  </google-chart>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="table-responsive">
                <table class="table table-striped">
                  <thead>
                    <tr>
                      <th>Categoría</th>
                      <th>Total</th>
                      <th>Activos</th>
                      <th>Inactivos</th>
                      <th>% Activos</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let category of dashboardData.productsByCategory">
                      <td><strong>{{ category.categoryName }}</strong></td>
                      <td>{{ category.totalProducts }}</td>
                      <td><span class="badge bg-success">{{ category.activeProducts }}</span></td>
                      <td><span class="badge bg-warning">{{ category.inactiveProducts }}</span></td>
                      <td>
                        <span class="fw-bold" 
                              [class.text-success]="(category.activeProducts / category.totalProducts) > 0.7"
                              [class.text-warning]="(category.activeProducts / category.totalProducts) <= 0.7 && (category.activeProducts / category.totalProducts) > 0.3"
                              [class.text-danger]="(category.activeProducts / category.totalProducts) <= 0.3">
                          {{ (category.activeProducts / category.totalProducts * 100) | number:'1.1-1' }}%
                        </span>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- REPORTE DE PEDIDOS -->
    <div *ngIf="activeTab === 'pedidos'" class="tab-content fade-in">
      
      <!-- Estado de Pedidos -->
      <div class="card report-card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="card-title mb-0">
            <i class="fas fa-clipboard-list me-2 text-primary"></i>
            Reporte de Estado de Pedidos
          </h5>
          <div class="report-actions">
            <button class="btn btn-success btn-sm me-2" (click)="downloadReport('estado-pedidos', 'excel')">
              <i class="fas fa-file-excel me-1"></i> Excel
            </button>
            <button class="btn btn-danger btn-sm" (click)="downloadReport('estado-pedidos', 'pdf')">
              <i class="fas fa-file-pdf me-1"></i> PDF
            </button>
          </div>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <div class="card chart-card">
                <div class="card-body">
                  <google-chart 
                    *ngIf="ordersByStatusChartData.length > 0"
                    [type]="ordersByStatusChartType"
                    [data]="ordersByStatusChartData"
                    [columns]="ordersByStatusChartColumns"
                    [options]="ordersByStatusChartOptions">
                  </google-chart>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="table-responsive">
                <table class="table table-striped">
                  <thead>
                    <tr>
                      <th>Estado</th>
                      <th>Cantidad</th>
                      <th>Porcentaje</th>
                      <th>Ingresos</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let status of dashboardData.ordersByStatus">
                      <td>
                        <span [class]="'badge ' + getOrderStatusColor(status.status)">
                          {{ translateStatus(status.status) }}
                        </span>
                      </td>
                      <td><strong>{{ status.totalOrders }}</strong></td>
                      <td>
                        <span class="fw-bold text-primary">
                          {{ status.percentage | number:'1.1-1' }}%
                        </span>
                      </td>
                      <td>
                        <span class="fw-bold text-success">
                          {{ formatCurrency(status.totalRevenue) }}
                        </span>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Pedidos por Fecha -->
      <div class="card report-card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="card-title mb-0">
            <i class="fas fa-calendar-alt me-2 text-info"></i>
            Reporte de Pedidos por Fecha
          </h5>
          <div class="report-actions">
            <button class="btn btn-success btn-sm me-2" (click)="downloadReport('pedidos-fecha', 'excel')">
              <i class="fas fa-file-excel me-1"></i> Excel
            </button>
            <button class="btn btn-danger btn-sm" (click)="downloadReport('pedidos-fecha', 'pdf')">
              <i class="fas fa-file-pdf me-1"></i> PDF
            </button>
          </div>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <div class="card chart-card">
                <div class="card-body">
                  <google-chart 
                    *ngIf="ordersByDateChartData.length > 0"
                    [type]="ordersByDateChartType"
                    [data]="ordersByDateChartData"
                    [columns]="ordersByDateChartColumns"
                    [options]="ordersByDateChartOptions">
                  </google-chart>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="table-responsive">
                <table class="table table-striped">
                  <thead>
                    <tr>
                      <th>Fecha</th>
                      <th>Total Pedidos</th>
                      <th>Completados</th>
                      <th>Cancelados</th>
                      <th>Ingresos</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let order of dashboardData.ordersByDate.slice(0, 15)">
                      <td><strong>{{ formatDate(order.date) }}</strong></td>
                      <td>{{ order.totalOrders }}</td>
                      <td><span class="badge bg-success">{{ order.completedOrders }}</span></td>
                      <td><span class="badge bg-danger">{{ order.cancelledOrders }}</span></td>
                      <td class="fw-bold text-success">{{ formatCurrency(order.totalRevenue) }}</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- REPORTE DE COMPRAS POR USUARIO -->
    <div *ngIf="activeTab === 'compras-usuarios'" class="tab-content fade-in">
      <div class="card report-card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="card-title mb-0">
            <i class="fas fa-user-tag me-2 text-primary"></i>
            Reporte de Compras por Usuario
          </h5>
          <div class="report-actions">
            <button class="btn btn-success btn-sm me-2" (click)="downloadReport('compras-usuario', 'excel')">
              <i class="fas fa-file-excel me-1"></i> Excel
            </button>
            <button class="btn btn-danger btn-sm" (click)="downloadReport('compras-usuario', 'pdf')">
              <i class="fas fa-file-pdf me-1"></i> PDF
            </button>
          </div>
        </div>
        <div class="card-body">
          <div class="row mb-4">
            <div class="col-md-6">
              <div class="card chart-card">
                <div class="card-body">
                  <google-chart 
                    *ngIf="topSpendersChartData.length > 0"
                    [type]="topSpendersChartType"
                    [data]="topSpendersChartData"
                    [columns]="topSpendersChartColumns"
                    [options]="topSpendersChartOptions">
                  </google-chart>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card bg-light">
                <div class="card-body text-center">
                  <h6 class="card-title">
                    <i class="fas fa-crown me-2 text-warning"></i>
                    Usuario que Más Gastó
                  </h6>
                  <p class="mb-1" *ngIf="getPurchasesStats()?.topSpender">
                    <strong>{{ getPurchasesStats()!.topSpender!.name }}</strong>
                  </p>
                  <h4 class="text-success fw-bold" *ngIf="getPurchasesStats()?.topSpender">
                    {{ formatCurrency(getPurchasesStats()!.topSpender!.amount) }}
                  </h4>
                </div>
              </div>
            </div>
          </div>
          
          <div class="table-responsive">
            <table class="table table-striped">
              <thead>
                <tr>
                  <th>Usuario</th>
                  <th>Email</th>
                  <th>Total Compras</th>
                  <th>Monto Total</th>
                  <th>Promedio por Compra</th>
                  <th>Última Compra</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let user of dashboardData.purchasesByUser">
                  <td>
                    <strong>{{ user.userName }}</strong>
                    <br>
                    <small class="text-muted">ID: {{ user.userId }}</small>
                  </td>
                  <td>
                    <small>{{ user.userEmail }}</small>
                  </td>
                  <td>
                    <span class="badge bg-primary">{{ user.totalPurchases }}</span>
                  </td>
                  <td>
                    <span [class]="'fw-bold ' + getSpendingColor(user.totalAmountSpent)">
                      {{ formatCurrency(user.totalAmountSpent) }}
                    </span>
                  </td>
                  <td>
                    <span class="text-info fw-bold">
                      {{ formatCurrency(user.averageOrderAmount) }}
                    </span>
                  </td>
                  <td>
                    <small>{{ formatLastPurchaseDate(user.lastPurchaseDate) }}</small>
                    <br>
                    <span [class]="'badge ' + getOrderStatusColor(user.lastOrderStatus)">
                      {{ translateStatus(user.lastOrderStatus) }}
                    </span>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Timestamp -->
    <div class="row mt-4">
      <div class="col-12">
        <div class="text-center text-muted">
          <small>
            <i class="fas fa-clock me-1"></i>
            Última actualización: {{ dashboardData.timestamp | date:'dd/MM/yyyy HH:mm:ss' }}
          </small>
        </div>
      </div>
    </div>
  </div>
</div>